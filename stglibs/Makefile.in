###############################################################################
# $Id: Makefile.in,v 1.28 2009/03/03 15:50:14 faust Exp $
###############################################################################

include ../../Makefile.conf

PROG = lib$(LIB_NAME).a

SEARCH_DIRS = -I ../../include -I . -I ./include

ifeq ($(STG_TIME), yes)
DEFS += -DSTG_TIME
endif

ifneq ($(LIB_DEFS),)
DEFS += $(LIB_DEFS)
endif

ifneq ($(LIB_INCS),)
SEARCH_DIRS += $(LIB_INCS)
endif

OBJS = $(notdir $(patsubst %.cpp, %.o, $(patsubst %.c, %.o, $(SRCS))))

CXXFLAGS += -fPIC $(SEARCH_DIRS) $(DEFS)
CFLAGS += -fPIC $(SEARCH_DIRS) $(DEFS)

all: $(PROG)

$(PROG): $(OBJS)
	ar rc lib$(LIB_NAME).a $(OBJS)
	ranlib lib$(LIB_NAME).a

clean:
	rm -f deps $(PROG) *.o *.a *.so tags *.*~ 

install: $(PROG)
	mkdir -m $(DIR_MODE) -p $(PREFIX)/usr/lib/stg
	install -m $(BIN_MODE) -o $(OWNER) -s $(PROG) $(PREFIX)/usr/lib/stg/$(PROG)
	mkdir -m $(DIR_MODE) -p $(PREFIX)/usr/include/stg
	install -m $(DATA_MODE) -o $(OWNER) $(addprefix include/stg/,$(INCS)) $(PREFIX)/usr/include/stg/

uninstall:
	rm -f $(PREFIX)/usr/lib/stg/$(PROG)
	for file in $(INCS); do \
	    rm -f $(PREFIX)/usr/include/stg/$$file; \
	done

ifneq ($(MAKECMDGOALS),includes)
ifneq ($(MAKECMDGOALS),clean)
ifneq ($(MAKECMDGOALS),uninstall)
-include deps
endif
endif
endif

deps:	$(SRCS) ../../Makefile.conf
	@>deps ;\
	for file in $(SRCS); do\
	  echo "$$file" | grep ".c$$" > /dev/null;\
	  if [ $$? -eq 0 ];\
	  then\
	    echo "`$(CC) $(CFLAGS) -MM $$file` Makefile ../../Makefile.conf" >> deps ;\
	    printf '%b\n' '\t$$(CC) $(CFLAGS) -c $$<' >> deps ;\
	  else\
	    echo "`$(CXX) $(CXXFLAGS) -MM $$file` Makefile ../../Makefile.conf" >> deps ;\
	    printf '%b\n' '\t$$(CXX) $(CXXFLAGS) -c $$<' >> deps ;\
	  fi;\
	done
